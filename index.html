<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobee Game Statistics Report</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background: #f5f5f5;
            padding: 20px;
            color: #1a1a1a;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 20px;
            position: relative;
        }

        h1 {
            font-size: 2em;
            font-weight: 700;
            margin-bottom: 10px;
            color: #1a1a1a;
        }

        .subtitle {
            font-size: 1em;
            font-style: italic;
            color: #666;
        }

        .pdf-download {
            position: absolute;
            top: 0;
            right: 0;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: #ccc;
            color: #1a1a1a;
            text-decoration: none;
            border: 1px solid black;
            border-radius: 5px;
            font-size: 0.9em;
            font-weight: 500;
            transition: background 0.3s ease;
        }

        .pdf-download:hover {
            background: #b8b8b8;
        }

        .pdf-icon {
            width: 20px;
            height: 20px;
        }

        .section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 1.1em;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 12px;
            padding-bottom: 4px;
            border-bottom: 1px solid #ecf0f1;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-box {
            border: 1px solid #ecf0f1;
            padding: 15px;
            background: #fafafa;
        }

        .stat-label {
            font-size: 0.85em;
            color: #34495e;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1.8em;
            font-weight: 700;
            color: #1a1a1a;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
        }

        th, td {
            padding: 8px 12px;
            text-align: left;
            border: 0.5px solid #bbb;
            font-size: 0.9em;
        }

        th {
            background: #ecf0f1;
            font-weight: 700;
            color: #2c3e50;
        }

        .rank-1 { background: #FFD700 !important; }
        .rank-2 { background: #C0C0C0 !important; }
        .rank-3 { background: #CD7F32 !important; }

        .chart-container {
            margin: 20px 0;
            max-width: 800px;
        }

        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .two-column {
                grid-template-columns: 1fr;
            }

            .container {
                padding: 20px;
            }

            h1 {
                font-size: 1.5em;
            }

            .pdf-download {
                position: static;
                margin: 0 auto 15px;
                width: fit-content;
            }

            header {
                display: flex;
                flex-direction: column;
            }
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 1.2em;
        }

        .error {
            background: #ff6b6b;
            color: white;
            padding: 20px;
            border-radius: 4px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="loading" class="loading">Loading statistics...</div>
        <div id="error" style="display: none;"></div>
        <div id="content" style="display: none;">
            <header>
                <a href="mobee_stats_report.pdf" class="pdf-download" download>
                    <img src="pdf.png" alt="PDF" class="pdf-icon">
                    Download PDF
                </a>
                <h1>MOBEE GAME STATISTICS REPORT</h1>
                <div class="subtitle" id="generatedDate">Generated: Loading...</div>
            </header>

            <!-- Overall Statistics -->
            <div class="section">
                <div class="section-title">OVERALL STATISTICS</div>
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-label">Total Games Played</div>
                        <div class="stat-value" id="totalGames">-</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Unique Players</div>
                        <div class="stat-value" id="uniquePlayers">-</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Average Score</div>
                        <div class="stat-value" id="avgScore">-</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Highest Score</div>
                        <div class="stat-value" id="maxScore">-</div>
                    </div>
                </div>
            </div>

            <!-- Score Distribution -->
            <div class="section">
                <div class="section-title">SCORE DISTRIBUTION</div>
                <table id="scoreDistTable">
                    <thead>
                        <tr>
                            <th>Range</th>
                            <th>Games</th>
                            <th>Percentage</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <div class="chart-container">
                    <canvas id="scoreDistChart"></canvas>
                </div>
            </div>

            <!-- High Score Leaderboard -->
            <div class="section">
                <div class="section-title">HIGH SCORE LEADERBOARD (TOP 15)</div>
                <table id="leaderboardTable">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Player</th>
                            <th>Score</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Daily Statistics -->
            <div class="section" id="dailySection" style="display: none;">
                <div class="section-title">DAILY STATISTICS (LAST 30 DAYS)</div>
                <table id="dailyStatsTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Games</th>
                            <th>Unique Players</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <div class="chart-container" style="max-width: 100%;">
                    <canvas id="dailyActivityChart"></canvas>
                </div>
            </div>

            <!-- Top 15 Players by Games Played -->
            <div class="section">
                <div class="section-title">TOP 15 PLAYERS BY GAMES PLAYED</div>
                <table id="topPlayersTable">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Player</th>
                            <th>Games</th>
                            <th>Avg Score</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <div class="chart-container">
                    <canvas id="topPlayersChart"></canvas>
                </div>
            </div>

            <!-- Platform Statistics -->
            <div class="section">
                <div class="section-title">PLATFORM STATISTICS (TOP 10)</div>
                <table id="platformTable">
                    <thead>
                        <tr>
                            <th>Platform</th>
                            <th>Games</th>
                            <th>Avg Score</th>
                            <th>Max Score</th>
                            <th>Share</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <div class="chart-container">
                    <canvas id="platformChart"></canvas>
                </div>
            </div>

            <!-- Platform Unique Players Chart -->
            <div class="section">
                <div class="chart-container">
                    <canvas id="platformPlayersChart"></canvas>
                </div>
            </div>

            <!-- Player Engagement -->
            <div class="section">
                <div class="section-title">PLAYER ENGAGEMENT</div>
                <table id="engagementTable">
                    <thead>
                        <tr>
                            <th>Category</th>
                            <th>Count</th>
                            <th>Percentage</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Top Countries -->
            <div class="section">
                <div class="section-title">TOP COUNTRIES</div>
                <table id="countryTable">
                    <thead>
                        <tr>
                            <th>Country</th>
                            <th>Games</th>
                            <th>Avg Score</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Top Cities -->
            <div class="section">
                <div class="section-title">TOP CITIES BY GAMES PLAYED</div>
                <div class="two-column">
                    <table id="topCitiesTable1">
                        <thead>
                            <tr>
                                <th>City</th>
                                <th>Games</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                    <table id="topCitiesTable2">
                        <thead>
                            <tr>
                                <th>City</th>
                                <th>Games</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let charts = {};

        async function loadStats() {
            try {
                let response;
                try {
                    response = await fetch('/api/stats');
                } catch (e) {
                    response = await fetch('mobee_stats.json');
                }

                if (!response.ok) throw new Error('Failed to load stats');
                const stats = await response.json();

                displayStats(stats);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';
            } catch (error) {
                console.error('Error loading stats:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').className = 'error';
                document.getElementById('error').textContent = 'Failed to load statistics. Please try again later.';
            }
        }

        function displayStats(stats) {
            // Update timestamp
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('generatedDate').textContent =
                `Generated: ${now.toLocaleDateString('en-US', options)}`;

            // Main stats
            document.getElementById('totalGames').textContent = stats.total_games.toLocaleString();
            document.getElementById('uniquePlayers').textContent = stats.unique_players.toLocaleString();
            document.getElementById('avgScore').textContent = stats.avg_score.toFixed(2);
            document.getElementById('maxScore').textContent = stats.max_score;

            // Score Distribution Table
            const scoreDistTable = document.getElementById('scoreDistTable').querySelector('tbody');
            const ranges = ['0-5', '6-10', '11-15', '16-20', '20+'];
            scoreDistTable.innerHTML = ranges.map(range => {
                const count = stats.score_distribution[range];
                const percentage = ((count / stats.total_games) * 100).toFixed(1);
                return `
                    <tr>
                        <td>${range}</td>
                        <td>${count}</td>
                        <td>${percentage}%</td>
                    </tr>
                `;
            }).join('');

            // Score Distribution Chart
            createScoreDistChart(stats);

            // High Score Leaderboard
            const leaderboardTable = document.getElementById('leaderboardTable').querySelector('tbody');
            leaderboardTable.innerHTML = stats.top_players_by_score.slice(0, 15).map((player, idx) => {
                const [code, score] = player;
                const rankClass = idx === 0 ? 'rank-1' : idx === 1 ? 'rank-2' : idx === 2 ? 'rank-3' : '';
                return `
                    <tr class="${rankClass}">
                        <td>${idx + 1}</td>
                        <td><strong>${code}</strong></td>
                        <td>${score}</td>
                    </tr>
                `;
            }).join('');

            // Daily Statistics
            if (stats.daily_stats && stats.daily_stats.length > 0) {
                document.getElementById('dailySection').style.display = 'block';

                // Populate daily stats table
                const dailyStatsTable = document.getElementById('dailyStatsTable').querySelector('tbody');
                const recentDays = stats.daily_stats.slice(-30); // Last 30 days

                dailyStatsTable.innerHTML = recentDays.map(day => {
                    const date = new Date(day.date);
                    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                    const formattedDate = date.toLocaleDateString('en-US', options);
                    return `
                        <tr>
                            <td>${formattedDate}</td>
                            <td style="text-align: center;">${day.games}</td>
                            <td style="text-align: center;">${day.unique_players}</td>
                        </tr>
                    `;
                }).join('');

                createDailyStatsChart(stats);
            }

            // Top 15 Players by Games Played
            const topPlayersTable = document.getElementById('topPlayersTable').querySelector('tbody');
            topPlayersTable.innerHTML = stats.top_players_by_games.slice(0, 15).map((player, idx) => {
                const [code, scores] = player;
                const avg = (scores.reduce((a, b) => a + b, 0) / scores.length).toFixed(2);
                return `
                    <tr>
                        <td>${idx + 1}</td>
                        <td><strong>${code}</strong></td>
                        <td>${scores.length}</td>
                        <td>${avg}</td>
                    </tr>
                `;
            }).join('');

            createTopPlayersChart(stats);

            // Platform Statistics
            const platformTable = document.getElementById('platformTable').querySelector('tbody');
            const platforms = Object.entries(stats.platform_scores)
                .sort((a, b) => b[1].count - a[1].count)
                .slice(0, 10);

            platformTable.innerHTML = platforms.map(([platform, data]) => {
                const percentage = ((data.count / stats.total_games) * 100).toFixed(1);
                return `
                    <tr>
                        <td>${platform}</td>
                        <td>${data.count}</td>
                        <td>${data.avg.toFixed(2)}</td>
                        <td>${data.max}</td>
                        <td>${percentage}%</td>
                    </tr>
                `;
            }).join('');

            createPlatformChart(stats);
            createPlatformPlayersChart(stats);

            // Player Engagement
            const engagementTable = document.getElementById('engagementTable').querySelector('tbody');
            const eng = stats.engagement;
            engagementTable.innerHTML = `
                <tr>
                    <td>One-time Players</td>
                    <td style="text-align: center;">${eng.one_time_players}</td>
                    <td style="text-align: center;">${((eng.one_time_players / stats.unique_players) * 100).toFixed(1)}%</td>
                </tr>
                <tr>
                    <td>Returning Players</td>
                    <td style="text-align: center;">${eng.returning_players}</td>
                    <td style="text-align: center;">${((eng.returning_players / stats.unique_players) * 100).toFixed(1)}%</td>
                </tr>
                <tr>
                    <td>Super Engaged (10+)</td>
                    <td style="text-align: center;">${eng.super_engaged}</td>
                    <td style="text-align: center;">${((eng.super_engaged / stats.unique_players) * 100).toFixed(1)}%</td>
                </tr>
            `;

            // Top Countries
            const countryTable = document.getElementById('countryTable').querySelector('tbody');
            const countries = Object.entries(stats.location_scores)
                .filter(([_, data]) => data.count >= 5)
                .sort((a, b) => b[1].count - a[1].count)
                .slice(0, 10);

            countryTable.innerHTML = countries.map(([country, data]) => {
                return `
                    <tr>
                        <td><strong>${country}</strong></td>
                        <td style="text-align: center;">${data.count}</td>
                        <td style="text-align: center;">${data.avg.toFixed(2)}</td>
                    </tr>
                `;
            }).join('');

            // Top Cities
            const cities = Object.entries(stats.city_counts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            const midpoint = Math.ceil(cities.length / 2);
            const cities1 = cities.slice(0, midpoint);
            const cities2 = cities.slice(midpoint);

            document.getElementById('topCitiesTable1').querySelector('tbody').innerHTML =
                cities1.map(([city, count]) => `
                    <tr>
                        <td><strong>${city}</strong></td>
                        <td style="text-align: center;">${count}</td>
                    </tr>
                `).join('');

            document.getElementById('topCitiesTable2').querySelector('tbody').innerHTML =
                cities2.map(([city, count]) => `
                    <tr>
                        <td><strong>${city}</strong></td>
                        <td style="text-align: center;">${count}</td>
                    </tr>
                `).join('');
        }

        function createScoreDistChart(stats) {
            const ctx = document.getElementById('scoreDistChart');
            if (charts.scoreDist) charts.scoreDist.destroy();

            const ranges = ['0-5', '6-10', '11-15', '16-20', '20+'];
            const data = ranges.map(r => stats.score_distribution[r]);

            charts.scoreDist = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ranges,
                    datasets: [{
                        label: 'Number of Games',
                        data: data,
                        backgroundColor: '#667eea',
                        borderColor: 'white',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        title: {
                            display: true,
                            text: 'Score Distribution',
                            font: { size: 14, weight: 'bold', family: 'Roboto' }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(0,0,0,0.1)' },
                            ticks: { font: { family: 'Roboto' } }
                        },
                        x: {
                            ticks: { font: { family: 'Roboto' } }
                        }
                    }
                }
            });
        }

        function createDailyStatsChart(stats) {
            const ctx = document.getElementById('dailyActivityChart');
            if (charts.daily) charts.daily.destroy();

            // Get last 30 days
            const dailyData = stats.daily_stats.slice(-30);
            const dates = dailyData.map(d => d.date);
            const games = dailyData.map(d => d.games);
            const players = dailyData.map(d => d.unique_players);

            charts.daily = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Games Played',
                        data: games,
                        backgroundColor: '#667eea',
                        borderColor: 'white',
                        borderWidth: 1,
                        yAxisID: 'y'
                    }, {
                        label: 'Unique Players',
                        data: players,
                        backgroundColor: '#764ba2',
                        borderColor: 'white',
                        borderWidth: 1,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Daily Activity (Last 30 Days)',
                            font: { size: 14, weight: 'bold', family: 'Roboto' }
                        },
                        legend: {
                            display: true,
                            labels: { font: { family: 'Roboto' } }
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Games Played',
                                font: { family: 'Roboto' }
                            },
                            grid: { color: 'rgba(0,0,0,0.1)' },
                            ticks: { font: { family: 'Roboto' } }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Unique Players',
                                font: { family: 'Roboto' }
                            },
                            grid: { drawOnChartArea: false },
                            ticks: { font: { family: 'Roboto' } }
                        },
                        x: {
                            ticks: {
                                font: { family: 'Roboto', size: 9 },
                                maxRotation: 45,
                                minRotation: 45,
                                callback: function(val, index) {
                                    // Show every 5th label to avoid crowding
                                    return index % 5 === 0 ? this.getLabelForValue(val) : '';
                                }
                            }
                        }
                    }
                }
            });
        }

        function createTopPlayersChart(stats) {
            const ctx = document.getElementById('topPlayersChart');
            if (charts.topPlayers) charts.topPlayers.destroy();

            // Sort by game count for horizontal bar chart
            const topPlayers = stats.top_players_by_games.slice(0, 15)
                .sort((a, b) => a[1].length - b[1].length);
            const labels = topPlayers.map(p => p[0]);
            const data = topPlayers.map(p => p[1].length);

            charts.topPlayers = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Games Played',
                        data: data,
                        backgroundColor: '#764ba2',
                        borderColor: 'white',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        title: {
                            display: true,
                            text: 'Top 15 Players by Games Played',
                            font: { size: 14, weight: 'bold', family: 'Roboto' }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            grid: { color: 'rgba(0,0,0,0.1)' },
                            ticks: { font: { family: 'Roboto' } }
                        },
                        y: {
                            ticks: { font: { family: 'Roboto', size: 9 } }
                        }
                    }
                }
            });
        }

        function createPlatformChart(stats) {
            const ctx = document.getElementById('platformChart');
            if (charts.platform) charts.platform.destroy();

            const platforms = Object.entries(stats.platform_scores)
                .sort((a, b) => b[1].count - a[1].count)
                .slice(0, 10);
            const labels = platforms.map(p => p[0].substring(0, 20));
            const data = platforms.map(p => p[1].count);

            // Generate colors using a gradient
            const colors = data.map((_, i) => {
                const ratio = i / Math.max(data.length - 1, 1);
                const r = Math.round(68 + (118 - 68) * ratio);
                const g = Math.round(138 + (75 - 138) * ratio);
                const b = Math.round(255 + (162 - 255) * ratio);
                return `rgb(${r}, ${g}, ${b})`;
            });

            charts.platform = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Games Played',
                        data: data,
                        backgroundColor: colors,
                        borderColor: 'white',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        title: {
                            display: true,
                            text: 'Top 10 Platforms by Games Played',
                            font: { size: 14, weight: 'bold', family: 'Roboto' }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(0,0,0,0.1)' },
                            ticks: { font: { family: 'Roboto' } }
                        },
                        x: {
                            ticks: {
                                font: { family: 'Roboto', size: 9 },
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });
        }

        function createPlatformPlayersChart(stats) {
            const ctx = document.getElementById('platformPlayersChart');
            if (charts.platformPlayers) charts.platformPlayers.destroy();

            const platforms = Object.entries(stats.platform_scores)
                .sort((a, b) => b[1].count - a[1].count)
                .slice(0, 10);
            const labels = platforms.map(p => p[0].substring(0, 20));

            // Note: We don't have unique players per platform in the stats
            // This would need to be calculated from raw game data
            // For now, we'll skip this chart or use a placeholder
            const data = platforms.map(p => p[1].count); // Using game count as placeholder

            // Generate colors using a different gradient (plasma-like)
            const colors = data.map((_, i) => {
                const ratio = i / Math.max(data.length - 1, 1);
                const r = Math.round(13 + (240 - 13) * ratio);
                const g = Math.round(8 + (249 - 8) * ratio);
                const b = Math.round(135 + (33 - 135) * ratio);
                return `rgb(${r}, ${g}, ${b})`;
            });

            charts.platformPlayers = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Unique Players',
                        data: data,
                        backgroundColor: colors,
                        borderColor: 'white',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        title: {
                            display: true,
                            text: 'Top 10 Platforms by Unique Players',
                            font: { size: 14, weight: 'bold', family: 'Roboto' }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(0,0,0,0.1)' },
                            ticks: { font: { family: 'Roboto' } }
                        },
                        x: {
                            ticks: {
                                font: { family: 'Roboto', size: 9 },
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });
        }

        // Load stats on page load
        loadStats();

        // Auto-refresh every 5 minutes
        setInterval(loadStats, 5 * 60 * 1000);
    </script>
</body>
</html>
